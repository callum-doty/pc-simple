{% extends "base.html" %} {% block title %}Search Documents - Document Catalog{%
endblock %} {% block content %}
<div class="row">
  <div class="col-md-8">
    <!-- Search Form -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">
          <i class="fas fa-search me-2"></i>Search Documents
        </h5>
        <form id="searchForm">
          <div class="row">
            <div class="col-md-8">
              <input
                type="text"
                class="form-control"
                id="searchQuery"
                placeholder="Search documents by filename, content, or keywords..."
              />
            </div>
            <div class="col-md-4">
              <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-search me-1"></i>Search
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Search Results -->
    <div id="searchResultsContainer" style="height: 80vh; overflow-y: auto">
      <div id="s" style="position: relative; width: 100%; height: 100%">
        <div
          id="searchResults"
          style="position: absolute; top: 0; left: 0; right: 0; bottom: 0"
        >
          <!-- Document cards will be inserted here -->
        </div>
      </div>
    </div>
    <div id="sentinel" style="height: 1px"></div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="text-center py-5" style="display: none">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">Searching documents...</p>
    </div>
  </div>

  <div class="col-md-4">
    <!-- Top Queries -->
    <div class="card mb-4">
      <div class="card-header">
        <h6 class="mb-0"><i class="fas fa-fire me-2"></i>Top Queries</h6>
      </div>
      <div class="card-body" id="topQueries">
        <!-- Top queries will be dynamically inserted here -->
      </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
      <div class="card-header">
        <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filters</h6>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label for="filterSearch" class="form-label">Filter by Term</label>
          <input
            type="text"
            id="filterSearch"
            class="form-control mb-2"
            placeholder="Search filters..."
          />
          <div class="accordion" id="canonicalTermAccordion">
            <!-- Accordion items will be dynamically inserted here -->
          </div>
        </div>
        <div class="mb-3">
          <label for="sortBy" class="form-label">Sort By</label>
          <select class="form-select" id="sortBy">
            <option value="relevance" selected>Relevance</option>
            <option value="created_at">Upload Date</option>
            <option value="filename">Filename</option>
            <option value="file_size">File Size</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="sortDirection" class="form-label">Sort Direction</label>
          <select class="form-select" id="sortDirection">
            <option value="desc">Newest First</option>
            <option value="asc">Oldest First</option>
          </select>
        </div>
        <button
          type="button"
          class="btn btn-outline-secondary btn-sm"
          id="clearFilters"
        >
          <i class="fas fa-times me-1"></i>Clear Filters
        </button>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Quick Stats</h6>
      </div>
      <div class="card-body">
        <div id="quickStats">
          <div class="d-flex justify-content-between mb-2">
            <span>Total Documents:</span>
            <span class="badge bg-primary" id="totalDocs">-</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Categories:</span>
            <span class="badge bg-info" id="totalCategories">-</span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Search Results:</span>
            <span class="badge bg-success" id="searchCount">-</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Document Card Template -->
  <template id="documentCardTemplate">
    <!-- Larger card with image on top -->
    <div class="card document-card mb-3" style="max-width: 100%">
      <!-- Image on top -->
      <a
        href="#"
        class="document-link-image d-block"
        target="_blank"
        rel="noopener noreferrer"
      >
        <img
          src=""
          class="card-img-top preview-image"
          alt="Document preview"
          style="height: 300px; object-fit: cover; width: 100%"
        />
      </a>

      <!-- Content below image -->
      <div class="card-body">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h6 class="card-title mb-0 flex-grow-1">
            <a
              href="#"
              class="document-link-filename filename text-decoration-none text-dark"
            ></a>
          </h6>
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-info relevance-score"></span>
            <div class="dropdown position-static">
              <button
                class="btn btn-sm btn-outline-secondary dropdown-toggle"
                type="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                style="z-index: 1050"
              >
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <div
                class="dropdown-menu dropdown-menu-end p-3"
                style="
                  min-width: 450px;
                  max-width: 600px;
                  z-index: 1060;
                  position: absolute;
                  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
                "
              >
                <!-- Extracted Text Section -->
                <div class="mb-3">
                  <h6 class="dropdown-header px-0 text-primary">
                    <i class="fas fa-file-text me-1"></i>Extracted Text
                  </h6>
                  <div
                    class="extracted-text-content p-2 bg-light rounded"
                    style="
                      max-height: 250px;
                      overflow-y: auto;
                      white-space: pre-wrap;
                      word-wrap: break-word;
                      font-size: 0.85em;
                      line-height: 1.4;
                      min-height: 50px;
                    "
                  >
                    <!-- Extracted text will be inserted here -->
                  </div>
                </div>

                <hr class="dropdown-divider" />

                <!-- Document Details Section -->
                <div class="mb-3">
                  <h6 class="dropdown-header px-0 text-success">
                    <i class="fas fa-info-circle me-1"></i>Document Details
                  </h6>
                  <div class="extra-info d-flex flex-wrap gap-1">
                    <!-- Extra info badges will be inserted here -->
                  </div>
                </div>

                <hr class="dropdown-divider" />

                <!-- Keywords Section -->
                <div class="mb-3">
                  <h6 class="dropdown-header px-0 text-warning">
                    <i class="fas fa-tags me-1"></i>Keywords & Terms
                  </h6>
                  <div class="keywords d-flex flex-wrap gap-1">
                    <!-- Keywords will be inserted here -->
                  </div>
                </div>

                <hr class="dropdown-divider" />

                <!-- Metadata Section -->
                <div>
                  <h6 class="dropdown-header px-0 text-info">
                    <i class="fas fa-cog me-1"></i>Metadata
                  </h6>
                  <div class="metadata-info d-flex flex-wrap gap-1">
                    <!-- Metadata will be inserted here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Summary -->
        <p class="card-text summary text-muted small mb-2"></p>

        <!-- Footer Info -->
        <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted">
            <i class="fas fa-calendar me-1"></i>
            <span class="upload-date"></span>
          </small>
        </div>
      </div>
    </div>
  </template>
  {% endblock %} {% block scripts %}
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      let currentPage = 1;
      let activeCanonicalTerm = "";
      let isLoading = false;
      let hasMore = true;
      let currentSearchQuery = "";
      let allDocuments = [];
      let visibleNodes = {};
      const ITEM_HEIGHT = 280; // Reduced height for horizontal card layout

      const searchResultsContainer = document.getElementById(
        "searchResultsContainer"
      );
      const sizer = document.getElementById("s");
      const searchResults = document.getElementById("searchResults");
      const loadingSpinner = document.getElementById("loadingSpinner");
      const sentinel = document.getElementById("sentinel");

      function loadTopQueries() {
        fetch("/api/search/top-queries")
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.queries) {
              const container = document.getElementById("topQueries");
              container.innerHTML = "";
              data.queries.forEach((item) => {
                const queryElement = document.createElement("button");
                queryElement.type = "button";
                queryElement.className =
                  "btn btn-outline-secondary btn-sm me-1 mb-1";
                queryElement.textContent = item.query;
                queryElement.addEventListener("click", () => {
                  document.getElementById("searchQuery").value = item.query;
                  performSearch(true);
                });
                container.appendChild(queryElement);
              });
            }
          })
          .catch((error) => console.error("Error loading top queries:", error));
      }

      function loadCanonicalTermFilters() {
        fetch("/api/taxonomy/canonical-terms")
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.terms) {
              updateCanonicalTermFilters(data.terms);
            }
          })
          .catch((error) =>
            console.error("Error loading canonical terms:", error)
          );
      }

      function updateCanonicalTermFilters(terms) {
        const accordion = document.getElementById("canonicalTermAccordion");
        accordion.innerHTML = "";
        const sanitizeForId = (text) => text.replace(/[^a-zA-Z0-9]/g, "-");

        const groupedTerms = Array.isArray(terms)
          ? terms.reduce((acc, term) => {
              const category = term.primary_category;
              if (!acc[category]) {
                acc[category] = [];
              }
              acc[category].push(term.term);
              return acc;
            }, {})
          : terms;

        for (const [category, termList] of Object.entries(groupedTerms)) {
          const categoryId = sanitizeForId(category);
          const accordionItem = document.createElement("div");
          accordionItem.className = "accordion-item";
          accordionItem.innerHTML = `
                    <h2 class="accordion-header" id="heading-${categoryId}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${categoryId}" aria-expanded="false" aria-controls="collapse-${categoryId}">
                            ${category}
                        </button>
                    </h2>
                    <div id="collapse-${categoryId}" class="accordion-collapse collapse" aria-labelledby="heading-${categoryId}" data-bs-parent="#canonicalTermAccordion">
                        <div class="accordion-body d-flex flex-wrap gap-2">
                            ${termList
                              .map(
                                (term) =>
                                  `<button type="button" class="btn btn-outline-secondary btn-sm" data-term="${term}">${term}</button>`
                              )
                              .join("")}
                        </div>
                    </div>
                `;
          accordion.appendChild(accordionItem);
        }
      }

      document
        .getElementById("canonicalTermAccordion")
        .addEventListener("click", (e) => {
          if (e.target.tagName === "BUTTON" && e.target.dataset.term) {
            const term = e.target.dataset.term;
            if (e.target.classList.contains("active")) {
              e.target.classList.remove("active", "btn-primary");
              e.target.classList.add("btn-outline-secondary");
              activeCanonicalTerm = "";
            } else {
              document
                .querySelectorAll("#canonicalTermAccordion button.btn")
                .forEach((btn) => {
                  btn.classList.remove("active", "btn-primary");
                  btn.classList.add("btn-outline-secondary");
                });
              e.target.classList.add("active", "btn-primary");
              e.target.classList.remove("btn-outline-secondary");
              activeCanonicalTerm = term;
            }
            performSearch(true);
          }
        });

      document.getElementById("filterSearch").addEventListener("keyup", (e) => {
        const searchText = e.target.value.toLowerCase();
        if (searchText.length > 2) {
          fetch(`/api/taxonomy/search?q=${searchText}`)
            .then((response) => response.json())
            .then((data) => {
              if (data.success && data.terms) {
                updateCanonicalTermFilters(data.terms);
              }
            });
        } else if (searchText.length === 0) {
          loadCanonicalTermFilters();
        }
      });

      document
        .getElementById("sortBy")
        .addEventListener("change", () => performSearch(true));
      document
        .getElementById("sortDirection")
        .addEventListener("change", () => performSearch(true));
      document.getElementById("searchForm").addEventListener("submit", (e) => {
        e.preventDefault();
        performSearch(true);
      });

      document.getElementById("clearFilters").addEventListener("click", () => {
        document.getElementById("searchQuery").value = "";
        document.getElementById("filterSearch").value = "";
        document
          .querySelectorAll("#canonicalTermAccordion button.btn")
          .forEach((btn) => {
            btn.classList.remove("active", "btn-primary");
            btn.classList.add("btn-outline-secondary");
          });
        activeCanonicalTerm = "";
        document.getElementById("sortBy").value = "relevance";
        document.getElementById("sortDirection").value = "desc";
        performSearch(true);
      });

      function performSearch(isNewSearch = false) {
        const query = document.getElementById("searchQuery").value;
        const sortBy = document.getElementById("sortBy").value;
        const sortDirection = document.getElementById("sortDirection").value;

        if (isNewSearch) {
          currentPage = 1;
          hasMore = true;
          allDocuments = [];
          visibleNodes = {};
          searchResults.innerHTML = "";
          currentSearchQuery = query;
        }

        if (isLoading || !hasMore) return;

        isLoading = true;
        loadingSpinner.style.display = "block";

        const params = new URLSearchParams({
          q: query,
          page: currentPage,
          per_page: 50, // Fetch more items at once
          sort_by: sortBy,
          sort_direction: sortDirection,
        });

        if (activeCanonicalTerm) {
          params.append("canonical_term", activeCanonicalTerm);
        }

        fetch(`/api/documents/search?${params}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.documents && data.documents.length > 0) {
              allDocuments.push(...data.documents);
              renderVisibleItems();
            } else if (isNewSearch) {
              searchResults.innerHTML = `
                            <div class="text-center py-5">
                                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No documents found</h5>
                                <p class="text-muted">Try adjusting your search terms or filters.</p>
                            </div>`;
            }
            updateStats(data);
            hasMore = data.pagination.has_next;
            if (hasMore) {
              currentPage++;
            }
          })
          .catch((error) => {
            console.error("Search error:", error);
            showError("An error occurred while searching. Please try again.");
          })
          .finally(() => {
            isLoading = false;
            loadingSpinner.style.display = "none";
          });
      }

      function renderVisibleItems() {
        const scrollTop = searchResultsContainer.scrollTop;
        const containerHeight = searchResultsContainer.clientHeight;

        const startIndex = Math.max(0, Math.floor(scrollTop / ITEM_HEIGHT) - 5);
        const endIndex = Math.min(
          allDocuments.length,
          Math.ceil((scrollTop + containerHeight) / ITEM_HEIGHT) + 5
        );

        const newVisibleNodes = {};

        for (let i = startIndex; i < endIndex; i++) {
          const doc = allDocuments[i];
          if (visibleNodes[doc.id]) {
            newVisibleNodes[doc.id] = visibleNodes[doc.id];
            delete visibleNodes[doc.id];
          } else {
            const card = createDocumentCard(doc);
            card.style.position = "absolute";
            card.style.top = `${i * ITEM_HEIGHT}px`;
            card.style.width = "100%";
            searchResults.appendChild(card);
            newVisibleNodes[doc.id] = card;
          }
        }

        // Remove nodes that are no longer visible
        for (const id in visibleNodes) {
          visibleNodes[id].remove();
        }

        visibleNodes = newVisibleNodes;
        sizer.style.height = `${allDocuments.length * ITEM_HEIGHT}px`;
      }

      function createDocumentCard(doc) {
        const template = document.getElementById("documentCardTemplate");
        const card = template.content.cloneNode(true).firstElementChild;

        const downloadUrl = `/api/documents/${doc.id}/download`;
        card.querySelector(".document-link-image").href = downloadUrl;
        card.querySelector(".document-link-filename").href = downloadUrl;

        card.querySelector(".filename").textContent = doc.filename;
        card.querySelector(".summary").textContent =
          doc.summary || "No summary available";
        card.querySelector(".upload-date").textContent = new Date(
          doc.created_at
        ).toLocaleDateString();

        if (doc.relevance) {
          card.querySelector(
            ".relevance-score"
          ).textContent = `Relevance: ${doc.relevance}`;
        }

        const previewImage = card.querySelector(".preview-image");
        if (doc.preview_url) {
          previewImage.src = doc.preview_url;
        } else {
          previewImage.src = "/static/placeholder.svg";
        }

        // Populate dropdown sections
        populateDropdownContent(card, doc);

        return card;
      }

      function populateDropdownContent(card, doc) {
        // Extracted Text
        const extractedTextContainer = card.querySelector(
          ".extracted-text-content"
        );
        if (doc.extracted_text && doc.extracted_text.trim()) {
          extractedTextContainer.textContent = doc.extracted_text;
        } else {
          extractedTextContainer.innerHTML =
            '<em class="text-muted">No extracted text available</em>';
        }

        // Extra Info (Document Details)
        const extraInfoContainer = card.querySelector(".extra-info");
        extraInfoContainer.innerHTML = "";
        if (doc.document_type) {
          extraInfoContainer.innerHTML += `<span class="badge bg-primary me-1 mb-1">${doc.document_type}</span>`;
        }
        if (doc.campaign_type) {
          extraInfoContainer.innerHTML += `<span class="badge bg-success me-1 mb-1">${doc.campaign_type}</span>`;
        }
        if (doc.document_tone) {
          extraInfoContainer.innerHTML += `<span class="badge bg-warning me-1 mb-1">${doc.document_tone}</span>`;
        }
        if (extraInfoContainer.innerHTML === "") {
          extraInfoContainer.innerHTML =
            '<em class="text-muted">No document details available</em>';
        }

        // Keywords
        const keywordsContainer = card.querySelector(".keywords");
        keywordsContainer.innerHTML = "";
        if (doc.canonical_terms && doc.canonical_terms.length > 0) {
          doc.canonical_terms.forEach((term) => {
            keywordsContainer.innerHTML += `<span class="badge bg-info keyword-badge me-1 mb-1">${term}</span>`;
          });
        } else {
          keywordsContainer.innerHTML =
            '<em class="text-muted">No canonical terms found</em>';
        }

        // Metadata
        const metadataContainer = card.querySelector(".metadata-info");
        metadataContainer.innerHTML = "";
        if (doc.status) {
          let statusClass = "secondary";
          if (doc.status === "COMPLETED") statusClass = "success";
          if (doc.status === "FAILED") statusClass = "danger";
          if (doc.status === "PROCESSING") statusClass = "primary";
          metadataContainer.innerHTML += `<span class="badge bg-${statusClass} me-1 mb-1">Status: ${doc.status}</span>`;
        }
        if (doc.file_size) {
          const sizeInKb = (doc.file_size / 1024).toFixed(2);
          metadataContainer.innerHTML += `<span class="badge bg-light text-dark me-1 mb-1">${sizeInKb} KB</span>`;
        }
        if (doc.mapping_count > 0) {
          metadataContainer.innerHTML += `<span class="badge bg-info me-1 mb-1">Mappings: ${doc.mapping_count}</span>`;
        }
        if (doc.has_embeddings) {
          metadataContainer.innerHTML += `<span class="badge bg-success me-1 mb-1"><i class="fas fa-check me-1"></i>Embeddings</span>`;
        } else {
          metadataContainer.innerHTML += `<span class="badge bg-danger me-1 mb-1"><i class="fas fa-times me-1"></i>No Embeddings</span>`;
        }
        if (doc.processing_error) {
          metadataContainer.innerHTML += `<div class="text-danger small mt-1 p-2 bg-light rounded" style="white-space: pre-wrap; word-wrap: break-word;" title="${doc.processing_error}"><i class="fas fa-exclamation-triangle me-1"></i>Processing Error: ${doc.processing_error}</div>`;
        }
        if (metadataContainer.innerHTML === "") {
          metadataContainer.innerHTML =
            '<em class="text-muted">No metadata available</em>';
        }
      }

      function updateStats(data) {
        document.getElementById("searchCount").textContent =
          data.total_count || 0;
      }

      function showError(message) {
        searchResults.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>
            `;
      }

      fetch("/api/stats")
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            document.getElementById("totalDocs").textContent =
              data.stats.total_documents || 0;
            document.getElementById("totalCategories").textContent =
              data.stats.status_counts?.completed || 0;
          }
        })
        .catch((error) => console.error("Stats error:", error));

      const observer = new IntersectionObserver(
        (entries) => {
          if (entries[0].isIntersecting && !isLoading && hasMore) {
            performSearch(false);
          }
        },
        {
          threshold: 1.0,
        }
      );
      observer.observe(sentinel);

      searchResultsContainer.addEventListener("scroll", renderVisibleItems);

      performSearch(true);
      loadCanonicalTermFilters();
      loadTopQueries();
    });
  </script>
  {% endblock %}
</div>
