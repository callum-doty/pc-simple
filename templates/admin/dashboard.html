<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
      }
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
      }
      .panel {
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 20px;
      }
      .panel h2 {
        margin-top: 0;
      }
    </style>
  </head>
  <body>
    <h1>Admin Dashboard</h1>

    <div class="dashboard-grid">
      <div class="panel">
        <h2>Executive Summary</h2>
        <p>Total Documents: <span id="total-docs">...</span></p>
        <p>Success Rate (7d): <span id="success-rate">...</span>%</p>
        <p>Avg. Processing Time: <span id="avg-time">...</span>s</p>
      </div>

      <div class="panel">
        <h2>Processing Pipeline</h2>
        <canvas id="processing-status-chart"></canvas>
      </div>

      <div class="panel">
        <h2>User Activity</h2>
        <canvas id="user-activity-chart"></canvas>
      </div>

      <div class="panel">
        <h2>AI Analysis Quality</h2>
        <canvas id="ai-quality-chart"></canvas>
      </div>

      <div class="panel">
        <h2>Cache Management</h2>
        <p>
          Clear Redis cache to force regeneration of preview URLs and search
          results.
        </p>
        <input
          type="password"
          id="upload-password"
          placeholder="Enter upload password"
          style="width: 100%; padding: 8px; margin: 10px 0"
        />
        <button
          onclick="clearCache()"
          style="
            background-color: #ff4444;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
          "
        >
          Clear Cache
        </button>
        <div
          id="cache-result"
          style="margin-top: 10px; padding: 10px; border-radius: 4px"
        ></div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          const response = await fetch("/api/dashboard");
          const data = await response.json();

          // Executive Summary
          document.getElementById("total-docs").textContent =
            data.core_processing.queue_depth; // This is not total docs, will fix later
          document.getElementById("success-rate").textContent =
            data.core_processing.processing_success_rate;
          document.getElementById("avg-time").textContent =
            data.core_processing.average_processing_time_seconds;

          // Processing Pipeline Chart
          new Chart(document.getElementById("processing-status-chart"), {
            type: "doughnut",
            data: {
              labels: ["Pending", "Processing", "Completed", "Failed"],
              datasets: [
                {
                  label: "Document Status",
                  data: [
                    data.core_processing.queue_depth,
                    0,
                    0,
                    0, // Placeholder values
                  ],
                  backgroundColor: ["#ffc107", "#007bff", "#28a745", "#dc3545"],
                },
              ],
            },
          });

          // User Activity Chart
          new Chart(document.getElementById("user-activity-chart"), {
            type: "bar",
            data: {
              labels: ["Searches (7d)", "Uploads (7d)"],
              datasets: [
                {
                  label: "Activity",
                  data: [
                    data.user_engagement.search_query_volume_7d,
                    data.user_engagement.upload_volume_7d,
                  ],
                  backgroundColor: ["#17a2b8", "#6f42c1"],
                },
              ],
            },
          });

          // AI Quality Chart
          new Chart(document.getElementById("ai-quality-chart"), {
            type: "bar",
            data: {
              labels: [
                "Analysis Completion",
                "Keyword Mapping",
                "Embedding Generation",
              ],
              datasets: [
                {
                  label: "Success Rate (%)",
                  data: [
                    data.ai_analysis.analysis_completion_rate,
                    data.ai_analysis.keyword_mapping_success_rate,
                    data.ai_analysis.embedding_generation_rate,
                  ],
                  backgroundColor: ["#fd7e14", "#20c997", "#6610f2"],
                },
              ],
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100,
                },
              },
            },
          });
        } catch (error) {
          console.error("Error fetching dashboard data:", error);
          document.body.innerHTML = "<h1>Error loading dashboard data</h1>";
        }
      });

      async function clearCache() {
        const password = document.getElementById("upload-password").value;
        const resultDiv = document.getElementById("cache-result");

        if (!password) {
          resultDiv.style.backgroundColor = "#f8d7da";
          resultDiv.style.color = "#721c24";
          resultDiv.textContent = "‚ùå Please enter the upload password";
          return;
        }

        resultDiv.textContent = "‚è≥ Clearing cache...";
        resultDiv.style.backgroundColor = "#fff3cd";
        resultDiv.style.color = "#856404";

        try {
          const formData = new FormData();
          formData.append("password", password);

          const response = await fetch("/api/admin/clear-cache", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          if (response.ok && data.success) {
            resultDiv.style.backgroundColor = "#d4edda";
            resultDiv.style.color = "#155724";
            resultDiv.innerHTML = `
              ‚úÖ Success!<br>
              Deleted ${data.deleted_count} cache entries<br>
              - ${data.search_keys} search keys<br>
              - ${data.facet_keys} facet keys<br>
              <br>
              Storage type: ${data.storage_type}<br>
              Direct URLs: ${data.use_direct_urls}<br>
              <br>
              üéâ Cache cleared! New searches will use streaming URLs.
            `;
          } else {
            resultDiv.style.backgroundColor = "#f8d7da";
            resultDiv.style.color = "#721c24";
            resultDiv.textContent = `‚ùå Error: ${
              data.detail || data.message || "Unknown error"
            }`;
          }
        } catch (error) {
          resultDiv.style.backgroundColor = "#f8d7da";
          resultDiv.style.color = "#721c24";
          resultDiv.textContent = `‚ùå Error: ${error.message}`;
        }
      }
    </script>
  </body>
</html>
